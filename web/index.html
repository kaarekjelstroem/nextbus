<!DOCTYPE html>
<html>
<head>
    <title>Next Bus</title>
    <!-- Twitter bootstrap -->
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap-theme.min.css">
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <script type="text/javascript" src="//netdna.bootstrapcdn.com/bootstrap/3.1.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.0/backbone-min.js"></script>
    <script src="js/geoposition.js"></script>
</head>
<body>

    <style>

        #map-canvas {
            width: 100%;
            height: 600px;
        }
        #wrapper {
            position: relative;
        }
        #over_map {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 99;
            width: 35%;
            background-color: rgba(245, 245, 245, 0.8);
            border-width: .2em;
            border-style: solid;
            border-color: black;
            padding: 7px;
        }
        #bus_time {
            position: absolute;
            top: 150px;
            right: 10px;
            z-index: 99;
            width: 35%;
            background-color: rgba(245, 245, 245, 0.8);
            border-width: .2em;
            border-style: solid;
            border-color: black;
            padding: 7px;
            overflow: auto;
         }
    </style>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC8_nX9UAjPSNth57C0w1_v-5cZ5eL9Ex0&sensor=true"></script>
    <script type="text/javascript">
        var map;
        function initGoogleMaps(latitude, longitude) {
            console.log('Loading map');
            var latLng = new google.maps.LatLng(latitude, longitude);
            var mapOptions = {
                   center: latLng,
                   zoom: 16
            };
            map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
            var marker = new google.maps.Marker({
                 position: latLng,
                 map: map,
                 title: 'You are here!'
            });
         }
    </script>

    <div class="container">
        <h1>Next Bus</h1>
        <hr/>
        <div id="wrapper">
            <div id="over_map">
                <h5 class="tmpl-address">DUMMY ADDRESS</h5>
                <div class="tmpl-district-select"></div>
                <br/>
                <div class="tmpl-routes-select"></div>
            </div>
            <div id="bus_time">
                <div class="tmp-schedule-table"></div>
            </div>
            <div id="map-canvas"/>
        </div>
    </div>

    <script type="text/template" id="address-template">
        <div class="view">
            <h5><%= address %></address>
        </div>
    </script>

    <script type="text/template" id="district-template">
        Districts: <select data-style="btn-success" id="district-selector">
        <% _.each(districts, function(district) {
                key = district.lat+ ',' + district.lon;
                if (seldistrict == key) {
                    selected = 'selected';
                } else {
                    selected = '';
                }
        %>
            <option <%= selected %> value="<%= key %>"><%= district.region %></option>
        <% }); %>
        </select>
    </script>

    <script type="text/template" id="route-template">
        <%
            if (typeof routes != 'undefined') { %>
            Bus routes: <select data-style="btn-success" id="route-selector">
                <%
                 _.each(routes, function(route) {
                    key = route.route.agencytag + ':' + route.route.routetag + ':' + route.route.latmin + ':' + route.route.lonmin;
                    if (selroute == key) {
                        selected = 'selected';
                    } else {
                        selected = '';
                    }
                %>
                   <option <%= selected%> value="<%= key %>"><%= route.route.title %></option>
                <% }); %>
            </select>
        <% } else { %>
            No available bus routes in this area!
        <% } %>
    </script>

    <script type="text/template" id="schedule-template">
        <h5>Schedule</h5>
        <table class="table table-striped table-bordered table-condensed">
            <%
            if(typeof schedules != 'undefined') {
            _.each(schedules.route.schedule, function(schedule) {
            %>
            <tr>
                <td><%= schedule.stop.title %></td>
                <td><%= schedule.stop.time %></td>
            </tr>
            <%
            });
            }
            %>
        </table>
    </script>

    <script>
        // TODO: Externalize this code

        var app = app || {};

        // Model for getting the current address from Google Geocode APIs
        app.AddressModel = Backbone.Model.extend({
            initialize: function() {
                this.updateUrl(app.latitude, app.longitude);
            },

            updateUrl: function(lat, lon) {
                this.url = 'http://maps.googleapis.com/maps/api/geocode/json?latlng=' + lat + ',' + lon + '&sensor=false';
            },

            url: ''
        });

        // View for setting the current addres
        app.AddressView = Backbone.View.extend({
            el: '.tmpl-address',

           initialize: function () {
             this.listenTo(this.model,'change', this.render);
             this.model.fetch();
           },
           render: function () {
               var address = this.model.attributes.results[0].formatted_address;
               console.log(address);
               var template = _.template($('#address-template').html(), {address: address});
               this.$el.html(template);
           }
        });

        // Model for getting the the list of districts
        app.DistrictModel = Backbone.Model.extend({
            url: '/regions'
        });

        // View for setting the districts
        app.DistrictView = Backbone.View.extend({
            el: '.tmpl-district-select',
            events: {
                "change #district-selector": "districtSelected"
            },
            districtSelected: function() {
                var latLng = this.$('#district-selector').val().split(',');
                app.latitude = latLng[0], app.longitude = latLng[1];

                map.setCenter(new google.maps.LatLng(app.latitude,
                                                     app.longitude), 30)
                map.setZoom(10);

                this.routesView.refresh();
            },
            initialize: function () {
                this.listenTo(this.model,'change', this.render);
                this.model.fetch();
            },
            render: function () {
                console.log(JSON.stringify(this.model.attributes));
                var template = _.template($('#district-template').html(),
                       {
                           districts: this.model.attributes,
                           seldistrict: ''
                       });
                this.$el.html(template);

                return this;
           }
        });

        app.RoutesModel = Backbone.Model.extend({
            initialize: function() {
                this.updateUrl(app.latitude, app.longitude);
            },
            updateUrl: function(lat, lon) {
                console.log("Coords:" + lat + "," + lon);
                this.url = '/routesnearlat/' + lat + '/lon/' + lon + '/precision/4';
            },
            url: ''
        });

        // View for setting the routes for a district
        app.RoutesView = Backbone.View.extend({
            el: '.tmpl-routes-select',
            events: {
                "change #route-selector": "routeSelected"
            },
            routeSelected: function() {
                var agencyRoute = this.$('#route-selector').val().split(':');
                app.agency = agencyRoute[0];
                app.route = agencyRoute[1];
                app.latitude = agencyRoute[2];
                app.longitude = agencyRoute[3];

                map.setCenter(new google.maps.LatLng(app.latitude,app.longitude), 30)
                map.setZoom(16);

                this.scheduleView.refresh();
            },
            initialize: function () {
                this.listenTo(this.model,'change', this.render);
                this.model.fetch();
            },
            render: function () {
                console.log(JSON.stringify(this.model.attributes));

                var template = _.template($('#route-template').html(),
                       {
                           routes: this.model.attributes,
                           selroute: ''
                       });
                this.$el.html(template);

                /*
                // Make sure we have an agency and a route!
                if(typeof app.agency == "undefined") {
                    var agencyRoute = this.$('#route-selector').val().split(':');
                    app.agency = agencyRoute[0];
                    app.route = agencyRoute[1];
                    console.log("Init agency, route:" + app.agency + "," + app.route);
                } else {
                    console.log("App.agency defined:" + app.agency);
                }


                this.scheduleView.refresh();
                */

                return this;
            },
            refresh: function () {
                this.model.updateUrl(app.latitude, app.longitude);
                this.model.fetch();
            }
        });

        // Schedule
        app.ScheduleModel = Backbone.Model.extend({
            initialize: function() {
                this.updateUrl(app.agency, app.route);
            },
            updateUrl: function(agency, route) {
                this.url = '/agency/' + agency + '/route/' + route + '/nextbus';
                console.log("Schedules.updateUrl:" + this.url);
            },
            url: ''
        });

        // View for showing the next schedule for a given route
        app.ScheduleView = Backbone.View.extend({
            el: '.tmp-schedule-table',
            initialize: function () {
                this.listenTo(this.model,'change', this.render);
            },
            render: function () {
                console.log(JSON.stringify(this.model.attributes));

                var template = _.template($('#schedule-template').html(),{ schedules: this.model.attributes });
                this.$el.html(template);
                return this;
            },
            refresh: function () {
                this.model.updateUrl(app.agency, app.route);
                this.model.fetch();
            }
        });


        var Router = Backbone.Router.extend({
            routes : {
                '' : 'home'
            }
        });

         // We need to know the location before we can do anything
        $(document).ready(function(){
            app.initLocation(function() {
                var router = new Router();
                router.on('route:home', function () {

                    initGoogleMaps(app.latitude, app.longitude);

                    var addressModel = new app.AddressModel();
                    var addressView = new app.AddressView({ model: addressModel });

                    var districtModel = new app.DistrictModel();
                    var districtView = new app.DistrictView({ model: districtModel });

                    var routesModel = new app.RoutesModel();
                    var routesView = new app.RoutesView({ model: routesModel });

                    districtView.routesView = routesView;

                    var scheduleModel = new app.ScheduleModel();
                    var scheduleView = new app.ScheduleView({ model: scheduleModel });

                    routesView.scheduleView = scheduleView;

                    console.log("DONE!!");
                })

                Backbone.history.start();
            })
        })

    </script>

</body>
</html>